name: Build and Publish MinIO Container
permissions:
  contents: read
  packages: write

on:
  push:
    tags:
      - 'minio-*'

jobs:
  setup:
    runs-on: ubuntu-latest
    if: startsWith(github.event.release.tag_name, 'minio-')
    outputs:
      container: ${{ steps.extract.outputs.container }}
      revision: ${{ steps.extract.outputs.revision }}
      version: ${{ steps.extract.outputs.version }}
      context: ${{ steps.versions.outputs.context }}
    steps:
      - name: Extract container, revision and version
        id: extract
        run: |
          TAG=${{ github.event.release.tag_name }}
          # Remove 'minio-' prefix
          REMAINING="${TAG#minio-}"
          # Extract revision (r1, r2, etc.)
          REVISION="${REMAINING%%-*}"
          # Extract version (everything after revision and dash)
          VERSION="${REMAINING#${REVISION}-}"
          CONTAINER="minio"
          
          if [ -z "$REVISION" ] || [ -z "$VERSION" ]; then
            echo "Invalid tag format for MinIO. Expected: minio-<revision>-<version>"
            echo "Example: minio-r1-2025-04-22T22-12-26Z"
            exit 1
          fi
          
          echo "container=$CONTAINER" >> $GITHUB_OUTPUT
          echo "revision=$REVISION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set context for MinIO
        id: versions
        run: |
          CONTEXT="docker/minio"
          echo "context=$CONTEXT" >> $GITHUB_OUTPUT

  build:
    needs: setup
    if: github.event.release.target_commitish == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set image tag
        id: tag
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          REVISION=${{ needs.setup.outputs.revision }}
          TAG="$VERSION-$REVISION"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GCR_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ needs.setup.outputs.context }}
          push: true
          build-args: |
            MINIO_VERSION=RELEASE.${{ needs.setup.outputs.version }}
          tags: ghcr.io/${{ github.repository_owner }}/containers/${{ needs.setup.outputs.container }}:${{ steps.tag.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
